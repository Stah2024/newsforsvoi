// === ЗАГРУЗКА НОВОСТЕЙ + MASONRY БЕЗ FOUC ===
fetch('/news.html')
  .then(response => response.text())
  .then(html => {
    const container = document.getElementById('news-container');
    const temp = document.createElement('div');
    temp.innerHTML = html;

    const items = Array.from(temp.querySelectorAll('.news-item'));

    items.sort((a, b) => {
      const timeA = new Date(a.querySelector('.timestamp')?.dataset.ts || 0);
      const timeB = new Date(b.querySelector('.timestamp')?.dataset.ts || 0);
      return timeB - timeA;
    });

    let visibleCount = 9;

    function renderItems() {
      container.innerHTML = '';
      items.slice(0, visibleCount).forEach(item => container.appendChild(item));

      const loadMoreBtn = document.getElementById('load-more');
      loadMoreBtn.style.display = visibleCount >= items.length ? 'none' : 'block';

      enableCardEnlargement();

      // === MASONRY: СКРЫТ ДО ЗАГРУЗКИ ===
      imagesLoaded(container, () => {
        let sizer = container.querySelector('.grid-sizer');
        if (!sizer) {
          sizer = document.createElement('div');
          sizer.className = 'grid-sizer';
          container.appendChild(sizer);
        }

        const msnry = new Masonry(container, {
          itemSelector: '.news-item',
          columnWidth: '.grid-sizer',
          gutter: 24,
          transitionDuration: 0
        });

        // Показываем после раскладки
        container.classList.add('loaded');
        msnry.layout();
      });
    }

    document.getElementById('load-more').addEventListener('click', () => {
      visibleCount += 9;
      renderItems();
    });

    renderItems();
  })
  .catch(error => {
    document.getElementById('news-container').innerHTML = '<p style="text-align:center;color:#666;">Не удалось загрузить новости.</p>';
    console.error('Ошибка загрузки news.html:', error);
  });