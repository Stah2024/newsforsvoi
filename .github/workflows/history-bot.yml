name: Run History Bot
on:
  schedule:
    - cron: '0 8,18 * * *'  # 08:00 и 18:00 CEST (10:00 и 20:00 MSK)
  workflow_dispatch:        # Ручной запуск
jobs:
  run-history-bot:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        persist-credentials: false
    - uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - run: |
        pip install pyTelegramBotAPI --upgrade
        pip install -r bot/requirements.txt
    - run: |
        mkdir -p public/media/
        python bot/history.py
        ls -la public/media/ || echo "Папка public/media/ пуста"
        git status
      env:
        TELEGRAM_HISTORY_TOKEN: ${{ secrets.TELEGRAM_HISTORY_TOKEN }}
    - run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git remote set-url origin https://x-access-token:${{ secrets.GH_PAT }}@github.com/Stah2024/newsforsvoi
        git add public/history.html
        if ls public/media/* >/dev/null 2>&1; then
          git add public/media/*
          echo "Добавлены медиафайлы"
        else
          echo "Нет медиафайлов"
        fi
        git commit -m "Update history.html and media [skip ci]" || echo "Нет изменений"
        git push
      env:
        GH_PAT: ${{ secrets.GH_PAT }}