name: Run Telegram Bot

on:
  schedule:
    # –ö–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç —Å 07:30 –¥–æ 22:05 –ú–°–ö ‚Üí —Å 04:30 –¥–æ 19:05 UTC
    - cron: '0,10,20,30,40,50 4-18 * * *'   # 04:00‚Äì18:59 UTC
    - cron: '5 19 * * *'                    # 19:05 UTC ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—É—Å–∫ –≤ 22:05 –ú–°–ö
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ ‚Äî –≤—Å–µ–≥–¥–∞ —Ä–∞–∑—Ä–µ—à—ë–Ω

jobs:
  run-bot:
    runs-on: ubuntu-latest

    env:
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      VK_TOKEN: ${{ secrets.VK_TOKEN }}
      VK_GROUP_ID: ${{ secrets.VK_GROUP_ID }}
      GH_PAT: ${{ secrets.GH_PAT }}

    steps:
      # === –ë–õ–û–ö–ò–†–û–í–ö–ê –ù–û–ß–ù–´–• –ê–í–¢–û–ó–ê–ü–£–°–ö–û–í ===
      - name: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–æ—á–Ω—ã—Ö –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–æ–≤ (22:05‚Äì07:30 –ú–°–ö)
        if: github.event_name == 'schedule'
        run: |
          CURRENT_UTC=$(date -u +%H:%M)
          HOUR=$(date -u +%H)
          MINUTE=$(date -u +%M)
          MINUTES=$((HOUR * 60 + MINUTE))

          # –ù–æ—á—å: —Å 19:05 UTC (1145 –º–∏–Ω) –¥–æ 04:30 UTC (270 –º–∏–Ω)
          if [ $MINUTES -ge 1145 ] || [ $MINUTES -le 270 ]; then
            echo "üåô –ù–æ—á—å! –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∑–∞–ø—Ä–µ—â—ë–Ω (22:05‚Äì07:30 –ú–°–ö)"
            echo "–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è UTC: $CURRENT_UTC"
            echo "–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ UI ‚Üí Actions ‚Üí Run workflow"
            exit 0  # ‚Üê –í—ã—Ö–æ–¥ –±–µ–∑ –æ—à–∏–±–∫–∏, –º–∏–Ω—É—Ç—ã –ø–æ—á—Ç–∏ –Ω–µ —Ç—Ä–∞—Ç—è—Ç—Å—è
          fi
          echo "‚òÄÔ∏è –î–µ–Ω—å! –ó–∞–ø—É—Å–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω. –í—Ä–µ–º—è UTC: $CURRENT_UTC"

      # === –û–°–ù–û–í–ù–´–ï –®–ê–ì–ò (–≤—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø—Ä–∏ —Ä—É—á–Ω–æ–º –∑–∞–ø—É—Å–∫–µ –∏ –¥–Ω—ë–º) ===
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install -r bot/requirements.txt

      - name: Run bot.py
        run: python bot/bot.py

      - name: Git commit and push
        run: |
          git config user.name "bot"
          git config user.email "bot@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${GH_PAT}@github.com/Stah2024/newsforsvoi.git
          git add public/news.html public/sitemap.xml public/rss.xml seen_ids.txt
          git commit -m "bot" || echo "ok"
          git push || echo "ok"