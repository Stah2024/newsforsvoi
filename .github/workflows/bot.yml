name: Run Telegram Bot and Deploy

on:
  schedule:
    - cron: '*/10 * * * *'  # ‚è∞ –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
  workflow_dispatch:        # üñê –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  run-bot:
    runs-on: ubuntu-22.04

    steps:
    - name: üì¶ Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v3
      with:
        persist-credentials: false
        fetch-depth: 0

    - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: pip install -r bot/requirements.txt

    - name: üöÄ –ó–∞–ø—É—Å–∫ bot.py
      working-directory: .
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      run: |
        echo "–ó–∞–ø—É—Å–∫ bot.py..."
        python bot/bot.py || echo "‚ö†Ô∏è bot.py –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π, –Ω–æ workflow –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è"

    - name: üíæ –ö–æ–º–º–∏—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å–∞–π—Ç–∞
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git remote set-url origin https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}
        git add public/news.html public/archive.html public/sitemap.xml
        git commit -m "üì∞ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–µ–π: –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å–≤–µ–∂–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–∑ Telegram" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
        git pull --ff-only || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
        git push

  deploy:
    needs: run-bot
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    steps:
    - name: üì¶ Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4

    - name: üõ† –°–±–æ—Ä–∫–∞ —Å–∞–π—Ç–∞ —Å Jekyll
      uses: actions/jekyll-build-pages@v1
      with:
        source: .
        destination: ./_site

    - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./_site

    - name: üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞ GitHub Pages
      uses: actions/deploy-pages@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}