name: Run Telegram Bot + Deploy to Yandex

on:
  schedule:
    - cron: '0,10,20,30,40,50 4-18 * * *'
    - cron: '5 19 * * *'
  workflow_dispatch:

jobs:
  run-bot-and-deploy:
    runs-on: ubuntu-latest

    env:
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      VK_TOKEN: ${{ secrets.VK_TOKEN }}
      VK_GROUP_ID: ${{ secrets.VK_GROUP_ID }}
      GH_PAT: ${{ secrets.GH_PAT }}
      YC_ACCESS_KEY: ${{ secrets.YC_ACCESS_KEY }}
      YC_SECRET_KEY: ${{ secrets.YC_SECRET_KEY }}

    steps:
      - name: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–æ—á–Ω—ã—Ö –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–æ–≤
        if: github.event_name == 'schedule'
        run: |
          CURRENT_UTC=$(date -u +%H:%M)
          HOUR=$(date -u +%H)
          MINUTE=$(date -u +%M)
          MINUTES=$((HOUR * 60 + MINUTE))
          if [ $MINUTES -ge 1145 ] || [ $MINUTES -le 270 ]; then
            echo "üåô –ù–æ—á—å! –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∑–∞–ø—Ä–µ—â—ë–Ω"
            exit 0
          fi
          echo "‚òÄÔ∏è –î–µ–Ω—å! –ó–∞–ø—É—Å–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω"

      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install -r bot/requirements.txt

      - name: Run bot.py
        run: python bot/bot.py

      - name: Git commit and push (with media)
        run: |
          git config user.name "bot"
          git config user.email "bot@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${GH_PAT}@github.com/Stah2024/newsforsvoi.git
          git add public/
          git commit -m "bot: update news + media" || echo "No changes to commit"
          git push || echo "No push needed"

      # === –î–ï–ü–õ–û–ô –ò–ó –ü–ê–ü–ö–ò public –ù–ê –Ø–ù–î–ï–ö–° ===
      - name: Deploy public/ to Yandex
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.YC_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.YC_SECRET_KEY }}
        run: |
          aws --endpoint-url=https://storage.yandexcloud.net \
            s3 sync public s3://newsforsvoi-backend \
            --acl public-read \
            --delete