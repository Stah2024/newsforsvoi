name: Run Telegram Bot

on:
  schedule:
    - cron: '*/10 * * * *'  # ‚è∞ –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-22.04

    steps:
    - name: üì¶ Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v3
      with:
        persist-credentials: false
        fetch-depth: 0

    - name: üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —É–¥–∞–ª—ë–Ω–Ω–æ–π –≤–µ—Ç–∫–æ–π
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git remote set-url origin https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}
        git fetch origin
        git reset --hard origin/main

    - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: pip install -r bot/requirements.txt

    - name: üïí –õ–æ–≥ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø—É—Å–∫–∞
      run: echo "‚è∞ –ó–∞–ø—É—Å–∫: $(date)"

    - name: üöÄ –ó–∞–ø—É—Å–∫ bot.py
      working-directory: .
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      run: |
        echo "‚úÖ bot.yml v8 –∞–∫—Ç–∏–≤–µ–Ω"
        python bot/bot.py || echo "‚ö†Ô∏è bot.py –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π, –Ω–æ workflow –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è"

    - name: üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏
      run: echo "–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—É—Å–∫: $(date)" > public/last-run.txt

    - name: üíæ –ö–æ–º–º–∏—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å–∞–π—Ç–∞
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
      run: |
        echo "üìÇ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:"
        git status

        git add public/news.html public/archive.html public/sitemap.xml seen_ids.txt public/last-run.txt

        if git diff --cached --quiet; then
          echo "‚ö†Ô∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äî –∫–æ–º–º–∏—Ç –ø—Ä–æ–ø—É—â–µ–Ω"
        else
          git commit -m "üß† –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–µ–π –∏ –±–∞–∑—ã ID ‚Äî autobot"
          git push || echo "‚ùå Push –Ω–µ –ø—Ä–æ—à—ë–ª"
        fi