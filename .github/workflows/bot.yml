name: Run Telegram Bot

on:
  schedule:
    - cron: '*/10 * * * *'  # ‚è∞ –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
  workflow_dispatch:        # üñê –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  run-bot:
    runs-on: ubuntu-22.04

    steps:
    - name: üì¶ Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v3
      with:
        persist-credentials: false
        fetch-depth: 0

    - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: üìö –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: pip install -r bot/requirements.txt

    - name: üöÄ –ó–∞–ø—É—Å–∫ bot.py
      working-directory: .
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      run: |
        echo "–ó–∞–ø—É—Å–∫ bot.py..."
        python bot/bot.py || echo "‚ö†Ô∏è bot.py –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π, –Ω–æ workflow –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è"

    - name: üíæ –ö–æ–º–º–∏—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å–∞–π—Ç–∞
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git remote set-url origin https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}

        git add public/news.html public/archive.html public/sitemap.xml seen_ids.txt
        git commit -m "üß† –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–µ–π –∏ –±–∞–∑—ã seen_ids" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"

        git pull --rebase || exit 1
        git push || echo "‚ùå Push –Ω–µ –ø—Ä–æ—à—ë–ª"